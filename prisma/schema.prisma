// =============================================================================
// Prisma Schema for Alterna Talent Management System
// =============================================================================
//
// This schema defines all database models for tracking candidates through
// the recruitment pipeline, from initial application to onboarding.
//
// Key Models:
// - Person: Unique individuals identified by email (personal info, GC results)
// - Application: Job applications linked to a Person (position, stage, docs)
// - User: Alterna personnel (synced from Okta)
// - Assessment: Test scores (general on Person, specialized on Application)
// - Interview: Interview scheduling and outcomes (linked to Application)
// - Decision: Final hiring decisions (linked to Application)
// - AuditLog: Complete activity trail for compliance
// - EmailLog: Email send history and status
//
// Architecture Decision:
// Person + Application model allows:
// - Same person applying to multiple roles
// - One general competencies assessment per person across all applications
// - Different stages for different role applications
// - Email-based deduplication prevents duplicate persons
//
// Note: Dreamhost MySQL uses utf8mb3 charset (limited emoji support)
// =============================================================================

generator client {
  provider     = "prisma-client"
  output       = "../lib/generated/prisma"
  moduleFormat = "esm"
}

datasource db {
  provider = "mysql"
}

// =============================================================================
// PERSON MODEL
// =============================================================================
// Represents a unique individual in the system, identified by email.
// Stores personal information and general competencies assessment results.
// A person can have multiple applications for different positions.
// =============================================================================

model Person {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Primary email address - unique identifier for deduplication
  email String @unique

  /// Person's first name
  firstName String

  /// Person's middle name (optional)
  middleName String?

  /// Person's last name
  lastName String

  /// Secondary/backup email (optional)
  secondaryEmail String?

  /// Phone number with country code
  phoneNumber String?

  /// Country of residence
  country String?

  /// City of residence
  city String?

  /// State/province/region
  state String?

  /// ISO country code (e.g., "US", "MX")
  countryCode String?

  /// Link to portfolio website
  portfolioLink String?

  /// Highest education level completed
  educationLevel String?

  // =========================================================================
  // General Competencies Assessment (tracked once per person)
  // =========================================================================

  /// Whether the person has completed the general competencies assessment
  generalCompetenciesCompleted Boolean @default(false)

  /// Score achieved on general competencies (0-100)
  generalCompetenciesScore Decimal? @db.Decimal(5, 2)

  /// When general competencies assessment was passed (null if not passed)
  generalCompetenciesPassedAt DateTime?

  // =========================================================================
  // Tally Integration
  // =========================================================================

  /// Tally respondentId - stored for reference but NOT used for deduplication
  /// Email is the primary deduplication key
  tallyRespondentId String?

  // =========================================================================
  // Okta Integration (for hired candidates)
  // =========================================================================

  /// Okta user ID (populated when person is hired and onboarded)
  oktaUserId String?

  // =========================================================================
  // Timestamps
  // =========================================================================

  /// When the person record was created
  createdAt DateTime @default(now())

  /// When the person record was last updated
  updatedAt DateTime @updatedAt

  // =========================================================================
  // Relations
  // =========================================================================

  /// All applications submitted by this person
  applications Application[]

  /// General competencies assessment (one per person)
  assessments Assessment[]

  /// Audit logs related to this person
  auditLogs AuditLog[]

  /// Emails sent to this person (not application-specific)
  emailLogs EmailLog[]

  // =========================================================================
  // Indexes
  // =========================================================================

  @@index([email])
  @@index([tallyRespondentId])
  @@index([createdAt])
}

// =============================================================================
// APPLICATION MODEL
// =============================================================================
// Represents a job application for a specific position.
// A person can have multiple applications (one per position).
// Each application tracks its own stage, status, and role-specific documents.
// =============================================================================

model Application {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Reference to the person who submitted this application
  personId String

  /// Position the person applied for
  position String

  /// Current stage in the recruitment pipeline
  currentStage Stage @default(APPLICATION)

  /// Current status (active, accepted, rejected)
  status Status @default(ACTIVE)

  // =========================================================================
  // Application-specific Documents
  // =========================================================================

  /// URL to resume file (hosted by Tally)
  resumeUrl String?

  /// Academic background description
  academicBackground String? @db.Text

  /// Previous work experience description
  previousExperience String? @db.Text

  /// Link to video introduction/presentation
  videoLink String?

  /// URL to additional files (hosted by Tally)
  otherFileUrl String?

  // =========================================================================
  // Package Contents Flags
  // What the applicant indicated they would submit in the form
  // Used to detect missing files (claimed to submit but file is missing)
  // =========================================================================

  /// Applicant indicated they have a resume
  hasResume Boolean @default(false)

  /// Applicant indicated they have academic background info
  hasAcademicBg Boolean @default(false)

  /// Applicant indicated they have a video introduction
  hasVideoIntro Boolean @default(false)

  /// Applicant indicated they have previous experience info
  hasPreviousExp Boolean @default(false)

  /// Applicant indicated they have other files
  hasOtherFile Boolean @default(false)

  // =========================================================================
  // Agreement Signing
  // =========================================================================

  /// When the agreement was signed by the candidate
  agreementSignedAt DateTime?

  /// Tally submission ID for the agreement form (unique, for idempotency)
  agreementTallySubmissionId String? @unique

  /// Raw agreement data from the Tally form (JSON)
  agreementData Json?

  // =========================================================================
  // Tally Integration
  // =========================================================================

  /// Tally form submission ID (unique, for idempotency)
  tallySubmissionId String @unique

  /// Tally response ID (for reference)
  tallyResponseId String?

  /// Tally form ID (to identify which form was used)
  tallyFormId String?

  // =========================================================================
  // Timestamps
  // =========================================================================

  /// When the application was submitted
  createdAt DateTime @default(now())

  /// When the application was last updated
  updatedAt DateTime @updatedAt

  // =========================================================================
  // Relations
  // =========================================================================

  /// The person who submitted this application
  person Person @relation(fields: [personId], references: [id], onDelete: Cascade)

  /// Specialized competencies assessments for this application
  assessments Assessment[]

  /// Interviews scheduled for this application
  interviews Interview[]

  /// Hiring decisions for this application
  decisions Decision[]

  /// Audit logs for this application
  auditLogs AuditLog[]

  /// Emails sent regarding this application
  emailLogs EmailLog[]

  // =========================================================================
  // Indexes
  // =========================================================================

  @@index([personId])
  @@index([status])
  @@index([currentStage])
  @@index([position])
  @@index([createdAt])
  @@index([status, currentStage])
  @@index([personId, status])
  @@index([agreementTallySubmissionId])
}

/// Recruitment pipeline stages
enum Stage {
  APPLICATION
  GENERAL_COMPETENCIES
  SPECIALIZED_COMPETENCIES
  INTERVIEW
  AGREEMENT
  SIGNED
}

/// Application status values
enum Status {
  ACTIVE
  ACCEPTED
  REJECTED
}

// =============================================================================
// ASSESSMENT MODEL
// =============================================================================
// Stores assessment results.
// - General competencies: Linked to Person (one per person across all apps)
// - Specialized competencies: Linked to Application (one per application)
// =============================================================================

model Assessment {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Type of assessment
  assessmentType AssessmentType

  /// Score achieved (0-100)
  score Decimal? @db.Decimal(5, 2)

  /// Whether the assessment was passed (score >= threshold)
  passed Boolean?

  /// Passing threshold for this assessment
  threshold Decimal? @db.Decimal(5, 2)

  /// When the assessment was completed (null for pending assessments)
  completedAt DateTime?

  /// Raw assessment data/answers (JSON format)
  rawData Json?

  // =========================================================================
  // Linkage (one of these must be set based on assessment type)
  // =========================================================================

  /// Reference to Person (for GENERAL_COMPETENCIES)
  personId String?

  /// Reference to Application (for SPECIALIZED_COMPETENCIES)
  applicationId String?

  /// Reference to SpecialisedCompetency definition (for SPECIALIZED_COMPETENCIES type)
  specialisedCompetencyId String?

  /// Extracted submission URLs from Tally (JSON array of {label, url, type})
  submissionUrls Json?

  /// When an admin reviewed this assessment (marked pass/fail)
  reviewedAt DateTime?

  /// Admin who reviewed this assessment
  reviewedBy String?

  // =========================================================================
  // Tally Integration
  // =========================================================================

  /// Tally submission ID for this assessment (for idempotency)
  tallySubmissionId String? @unique

  // =========================================================================
  // Timestamps
  // =========================================================================

  /// Record creation timestamp
  createdAt DateTime @default(now())

  /// Last update timestamp
  updatedAt DateTime @updatedAt

  // =========================================================================
  // Relations
  // =========================================================================

  /// The person who took this assessment (general competencies)
  person Person? @relation(fields: [personId], references: [id], onDelete: Cascade)

  /// The application this assessment is for (specialized competencies)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)

  /// The specialised competency definition this assessment is for
  specialisedCompetency SpecialisedCompetency? @relation(fields: [specialisedCompetencyId], references: [id], onDelete: SetNull)

  /// The admin who reviewed this assessment
  reviewer User? @relation("AssessmentReviewer", fields: [reviewedBy], references: [id], onDelete: SetNull)

  // =========================================================================
  // Indexes
  // =========================================================================

  @@index([personId])
  @@index([applicationId])
  @@index([assessmentType])
  @@index([specialisedCompetencyId])
  @@index([reviewedBy])
}

/// Types of assessments
enum AssessmentType {
  GENERAL_COMPETENCIES
  SPECIALIZED_COMPETENCIES
}

// =============================================================================
// SPECIALISED COMPETENCY MODEL
// =============================================================================
// Defines specialised competency assessments that can be assigned to candidates.
// Each SC has its own Tally form and evaluation criterion.
// Soft-deleted via isActive flag to preserve historical assessment data.
// =============================================================================

model SpecialisedCompetency {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Display name of the competency (e.g. "Code Review", "Instructional Design")
  name String

  /// Category for grouping/display (e.g. "Technical", "Creative")
  category String

  /// URL to the Tally form for this assessment
  tallyFormUrl String

  /// Evaluation criterion â€” what the candidate must demonstrate
  criterion String @db.Text

  /// Whether this SC is active (false = soft-deleted)
  isActive Boolean @default(true)

  /// Record creation timestamp
  createdAt DateTime @default(now())

  /// Last update timestamp
  updatedAt DateTime @updatedAt

  // Relations
  assessments Assessment[]

  @@index([isActive])
  @@index([category])
}

// =============================================================================
// INTERVIEW MODEL
// =============================================================================
// Tracks interview scheduling and outcomes.
// Linked to Application (not Person) since interviews are position-specific.
// Interviewers provide their Cal.com/Calendly links for scheduling.
// =============================================================================

model Interview {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Reference to the application
  applicationId String

  /// Reference to the interviewer (User)
  interviewerId String

  /// Interviewer's scheduling link (Cal.com/Calendly)
  schedulingLink String

  /// When the interview is scheduled for
  scheduledAt DateTime?

  /// When the interview was completed
  completedAt DateTime?

  /// Interviewer's notes
  notes String? @db.Text

  /// Interview outcome
  outcome InterviewOutcome @default(PENDING)

  /// When the interview invitation email was sent
  emailSentAt DateTime?

  /// Record creation timestamp
  createdAt DateTime @default(now())

  /// Last update timestamp
  updatedAt DateTime @updatedAt

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  interviewer User        @relation(fields: [interviewerId], references: [id])

  @@index([applicationId])
  @@index([interviewerId])
  @@index([scheduledAt])
}

/// Interview outcome values
enum InterviewOutcome {
  PENDING
  ACCEPT
  REJECT
}

// =============================================================================
// USER MODEL
// =============================================================================
// Alterna personnel synced from Okta.
// Includes administrators and hiring managers.
// =============================================================================

model User {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Okta user ID for SSO integration
  oktaUserId String @unique

  /// Alterna email address (primary identifier)
  email String @unique

  /// Secondary email address
  secondaryEmail String?

  /// First name
  firstName String

  /// Middle name
  middleName String?

  /// Last name
  lastName String

  /// Display name (shown in UI)
  displayName String

  /// Job title
  title String?

  /// City
  city String?

  /// State/province
  state String?

  /// ISO country code
  countryCode String?

  /// Preferred language (ISO code)
  preferredLanguage String @default("en")

  /// Timezone (IANA format)
  timezone String @default("America/New_York")

  /// Organization name
  organisation String @default("Alterna")

  /// Operational clearance level
  operationalClearance Clearance @default(A)

  /// Whether user is admin (in talent-administration group)
  isAdmin Boolean @default(false)

  /// Whether user has app access (in talent-access OR talent-administration group)
  hasAppAccess Boolean @default(false)

  /// Personal scheduling link (Cal.com/Calendly)
  schedulingLink String?

  /// User status in Okta (ACTIVE, SUSPENDED, DEPROVISIONED, etc.)
  oktaStatus OktaStatus @default(ACTIVE)

  /// Record creation timestamp
  createdAt DateTime @default(now())

  /// Last update timestamp
  updatedAt DateTime @updatedAt

  /// When user data was last synced from Okta
  lastSyncedAt DateTime?

  // Relations
  interviews          Interview[]
  decisions           Decision[]
  auditLogs           AuditLog[]
  sentEmails          EmailLog[]
  reviewedAssessments Assessment[] @relation("AssessmentReviewer")

  @@index([oktaUserId])
  @@index([email])
}

/// Operational clearance levels
enum Clearance {
  A
  B
  C
}

/// Okta user status values
enum OktaStatus {
  STAGED
  PROVISIONED
  ACTIVE
  RECOVERY
  LOCKED_OUT
  PASSWORD_EXPIRED
  SUSPENDED
  DEPROVISIONED
}

// =============================================================================
// DECISION MODEL
// =============================================================================
// Records final hiring decisions for applications.
// Reason is required for rejections (GDPR compliance).
// =============================================================================

model Decision {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Reference to the application
  applicationId String

  /// The decision (accept or reject)
  decision DecisionType

  /// Reason for the decision (required for rejections)
  reason String @db.Text

  /// User who made the decision
  decidedBy String

  /// When the decision was made
  decidedAt DateTime @default(now())

  /// Additional notes
  notes String? @db.Text

  /// Record creation timestamp
  createdAt DateTime @default(now())

  /// Last update timestamp
  updatedAt DateTime @updatedAt

  // Relations
  application Application @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  user        User        @relation(fields: [decidedBy], references: [id])

  @@index([applicationId])
  @@index([decidedBy])
}

/// Decision types
enum DecisionType {
  ACCEPT
  REJECT
}

// =============================================================================
// AUDIT LOG MODEL
// =============================================================================
// Comprehensive activity logging for compliance and debugging.
// Can be linked to Person, Application, or both for context.
// =============================================================================

model AuditLog {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Reference to related person (optional)
  personId String?

  /// Reference to related application (optional)
  applicationId String?

  /// Reference to user who performed action (optional)
  userId String?

  /// Human-readable action description
  action String @db.VarChar(100)

  /// Type of action for filtering
  actionType ActionType

  /// Additional details (JSON format)
  details Json?

  /// IP address of the request
  ipAddress String?

  /// User agent string
  userAgent String? @db.Text

  /// When the action occurred
  createdAt DateTime @default(now())

  // Relations
  person      Person?      @relation(fields: [personId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  user        User?        @relation(fields: [userId], references: [id], onDelete: SetNull)

  @@index([personId])
  @@index([applicationId])
  @@index([userId])
  @@index([createdAt])
  @@index([actionType])
}

/// Types of logged actions
enum ActionType {
  CREATE
  UPDATE
  DELETE
  VIEW
  EMAIL_SENT
  STATUS_CHANGE
  STAGE_CHANGE
}

// =============================================================================
// EMAIL LOG MODEL
// =============================================================================
// Tracks all emails sent through the system.
// Can be linked to Person, Application, or both depending on email type.
// =============================================================================

model EmailLog {
  /// Unique identifier (UUID)
  id String @id @default(uuid())

  /// Reference to the person (optional - for person-level emails)
  personId String?

  /// Reference to the application (optional - for application-specific emails)
  applicationId String?

  /// Email address the email was sent to
  recipientEmail String

  /// Name of the email template used
  templateName String

  /// Email subject line
  subject String

  /// When the email was actually sent
  sentAt DateTime?

  /// Current status of the email
  status EmailStatus @default(PENDING)

  /// Error message if send failed
  errorMessage String? @db.Text

  /// User who triggered the email (optional for automated emails)
  sentBy String?

  /// Record creation timestamp
  createdAt DateTime @default(now())

  /// Last update timestamp
  updatedAt DateTime @updatedAt

  // Relations
  person      Person?      @relation(fields: [personId], references: [id], onDelete: Cascade)
  application Application? @relation(fields: [applicationId], references: [id], onDelete: Cascade)
  user        User?        @relation(fields: [sentBy], references: [id], onDelete: SetNull)

  @@index([personId])
  @@index([applicationId])
  @@index([status])
  @@index([sentAt])
}

/// Email delivery status
enum EmailStatus {
  PENDING
  SENT
  FAILED
  BOUNCED
}
